!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Phaser4={})}(this,(function(t){"use strict";function e(t=document.createElement("audio")){return""!==t.canPlayType("audio/x-m4a")||""!==t.canPlayType("audio/aac")}function r(t=document.createElement("audio")){return""!==t.canPlayType('audio/mpeg; codecs="mp3"')}function i(t=document.createElement("audio")){return""!==t.canPlayType('audio/ogg; codecs="vorbis"')}function s(t=document.createElement("audio")){return""!==t.canPlayType('audio/ogg; codecs="opus"')||""!==t.canPlayType('audio/webm; codecs="opus"')}function n(t=document.createElement("audio")){return""!==t.canPlayType('audio/wav; codecs="1"')}function a(t=document.createElement("audio")){return""!==t.canPlayType('audio/webm; codecs="vorbis"')}function o(){return window.hasOwnProperty("Audio")}function h(){return window.hasOwnProperty("AudioContext")||window.hasOwnProperty("webkitAudioContext")}function u(){const t={audioData:o(),m4a:!1,mp3:!1,ogg:!1,opus:!1,wav:!1,webAudio:h(),webm:!1};if(t.audioData){const o=document.createElement("audio");try{!!o.canPlayType&&(t.m4a=e(o),t.mp3=r(o),t.ogg=i(o),t.opus=s(o),t.wav=n(o),t.webm=a(o))}catch(e){t.audioData=!1}}return t}function c(){const t=/Chrome\/(\d+)/.test(navigator.userAgent);return{chrome:t,chromeVersion:t?parseInt(RegExp.$1,10):0}}function d(){return{edge:/Edge\/\d+/.test(navigator.userAgent)}}function l(){const t=/Firefox\D+(\d+)/.test(navigator.userAgent);return{firefox:t,firefoxVersion:t?parseInt(RegExp.$1,10):0}}function f(){const t=navigator.userAgent,e={iOS:!1,iOSVersion:0,iPhone:!1,iPad:!1};return/iP[ao]d|iPhone/i.test(t)&&(navigator.appVersion.match(/OS (\d+)/),e.iOS=!0,e.iOSVersion=parseInt(RegExp.$1,10),e.iPhone=-1!==t.toLowerCase().indexOf("iphone"),e.iPad=-1!==t.toLowerCase().indexOf("ipad")),e}function m(){const{iOS:t}=f();return{mobileSafari:/AppleWebKit/.test(navigator.userAgent)&&t}}function x(){const t=/MSIE (\d+\.\d+);/.test(navigator.userAgent);return{ie:t,ieVersion:t?parseInt(RegExp.$1,10):0}}function g(){return{opera:/Opera/.test(navigator.userAgent)}}function p(){const t=navigator.userAgent;return/Windows Phone/i.test(t)||/IEMobile/i.test(t)}function y(){const t=navigator.userAgent;return{safari:/Safari/.test(t)&&!p(),safariVersion:/Version\/(\d+)\./.test(t)?parseInt(RegExp.$1,10):0}}function T(){return{silk:/Silk/.test(navigator.userAgent)}}function b(){const t=/Trident\/(\d+\.\d+)(.*)rv:(\d+\.\d+)/.test(navigator.userAgent);return{trident:t,tridentVersion:t?parseInt(RegExp.$1,10):0,tridentIEVersion:t?parseInt(RegExp.$3,10):0}}function w(){const{chrome:t,chromeVersion:e}=c(),{edge:r}=d(),{firefox:i,firefoxVersion:s}=l();let{ie:n,ieVersion:a}=x();const{mobileSafari:o}=m(),{opera:h}=g(),{safari:u,safariVersion:f}=y(),{silk:p}=T(),{trident:w,tridentVersion:v,tridentIEVersion:S}=b();return w&&(n=!0,a=S),{chrome:t,chromeVersion:e,edge:r,firefox:i,firefoxVersion:s,ie:n,ieVersion:a,mobileSafari:o,opera:h,safari:u,safariVersion:f,silk:p,trident:w,tridentVersion:v}}function v(){return/Android/.test(navigator.userAgent)}function S(){return/CrOS/.test(navigator.userAgent)}function E(){return window.hasOwnProperty("cordova")}function A(){return/Crosswalk/.test(navigator.userAgent)}function R(){return window.hasOwnProperty("ejecta")}function _(){return"undefined"!=typeof process&&"object"==typeof process.versions&&process.versions.hasOwnProperty("node")}function M(){return _()&&!!process.versions.electron}function F(){const t=navigator.userAgent;return/Kindle/.test(t)||/\bKF[A-Z][A-Z]+/.test(t)||/Silk.*Mobile Safari/.test(t)}function P(){return/Linux/.test(navigator.userAgent)}function C(){const t=navigator.userAgent;return/Mac OS/.test(t)&&!/like Mac OS/.test(t)}function D(){return _()&&!!process.versions["node-webkit"]}function O(){return navigator.hasOwnProperty("standalone")}function z(){return/Windows/.test(navigator.userAgent)}function L(){const t=navigator.userAgent,{iOS:e,iOSVersion:r,iPad:i,iPhone:s}=f(),n={android:v(),chromeOS:S(),cordova:E(),crosswalk:A(),desktop:!1,ejecta:R(),electron:M(),iOS:e,iOSVersion:r,iPad:i,iPhone:s,kindle:F(),linux:P(),macOS:C(),node:_(),nodeWebkit:D(),pixelRatio:1,webApp:O(),windows:z(),windowsPhone:p()};n.windowsPhone&&(n.android=!1,n.iOS=!1,n.macOS=!1,n.windows=!0);const a=/Silk/.test(t);return(n.windows||n.macOS||n.linux&&!a||n.chromeOS)&&(n.desktop=!0),(n.windowsPhone||/Windows NT/i.test(t)&&/Touch/i.test(t))&&(n.desktop=!1),n}function B(t=document.createElement("video")){return""!==t.canPlayType('video/mp4; codecs="avc1.42E01E"')}function U(t=document.createElement("video")){return""!==t.canPlayType('application/x-mpegURL; codecs="avc1.42E01E"')}function I(t=document.createElement("video")){return""!==t.canPlayType('video/ogg; codecs="theora"')}function V(t=document.createElement("video")){return""!==t.canPlayType('video/webm; codecs="vp9"')}function k(t=document.createElement("video")){return""!==t.canPlayType('video/webm; codecs="vp8, vorbis"')}function G(){const t={h264Video:!1,hlsVideo:!1,mp4Video:!1,oggVideo:!1,vp9Video:!1,webmVideo:!1},e=document.createElement("video");try{!!e.canPlayType&&(t.h264Video=B(e),t.hlsVideo=U(e),t.oggVideo=I(e),t.vp9Video=V(e),t.webmVideo=k(e))}catch(t){}return t.mp4Video=t.hlsVideo,t}var N={Audio:Object.freeze({__proto__:null,canPlayM4A:e,canPlayMP3:r,canPlayOGG:i,canPlayOpus:s,canPlayWAV:n,canPlayWebM:a,GetAudio:u,hasAudio:o,hasWebAudio:h}),Browser:Object.freeze({__proto__:null,GetBrowser:w,isChrome:c,isEdge:d,isFirefox:l,isMobileSafari:m,isMSIE:x,isOpera:g,isSafari:y,isSilk:T,isTrident:b}),OS:Object.freeze({__proto__:null,GetOS:L,isAndroid:v,isChromeOS:S,isCordova:E,isCrosswalk:A,isEjecta:R,isElectron:M,isiOS:f,isKindle:F,isLinux:P,isMacOS:C,isNode:_,isNodeWebkit:D,isWebApp:O,isWindows:z,isWindowsPhone:p}),Video:Object.freeze({__proto__:null,canPlayH264Video:B,canPlayHLSVideo:U,canPlayOGGVideo:I,canPlayVP9Video:V,canPlayWebMVideo:k,GetVideo:G})},X=Object.freeze({__proto__:null,default:N,canPlayM4A:e,canPlayMP3:r,canPlayOGG:i,canPlayOpus:s,canPlayWAV:n,canPlayWebM:a,GetAudio:u,hasAudio:o,hasWebAudio:h,GetBrowser:w,isChrome:c,isEdge:d,isFirefox:l,isMobileSafari:m,isMSIE:x,isOpera:g,isSafari:y,isSilk:T,isTrident:b,GetOS:L,isAndroid:v,isChromeOS:S,isCordova:E,isCrosswalk:A,isEjecta:R,isElectron:M,isiOS:f,isKindle:F,isLinux:P,isMacOS:C,isNode:_,isNodeWebkit:D,isWebApp:O,isWindows:z,isWindowsPhone:p,canPlayH264Video:B,canPlayHLSVideo:U,canPlayOGGVideo:I,canPlayVP9Video:V,canPlayWebMVideo:k,GetVideo:G});function W(t,e){let r;if(e)"string"==typeof e?r=document.getElementById(e):"object"==typeof e&&1===e.nodeType&&(r=e);else if(t.parentElement)return t;return r||(r=document.body),r.appendChild(t),t}function j(t){const e=document.readyState;if("complete"===e||"interactive"===e)return void t();const r=()=>{document.removeEventListener("deviceready",r,!0),document.removeEventListener("DOMContentLoaded",r,!0),window.removeEventListener("load",r,!0),t()};document.body?window.hasOwnProperty("cordova")?document.addEventListener("deviceready",r,!0):(document.addEventListener("DOMContentLoaded",r,!0),window.addEventListener("load",r,!0)):window.setTimeout(r,20)}var Y=Object.freeze({__proto__:null,AddToDOM:W,DOMContentLoaded:j,RemoveFromDOM:function(t){t.parentNode&&t.parentNode.removeChild(t)}});class H{constructor(t=0,e=0,r=0,i=0){this.set(t,e,r,i)}set(t=0,e=0,r=0,i=0){return this.x=t,this.y=e,this.width=r,this.height=i,this}set right(t){t<=this.x?this.width=0:this.width=t-this.x}get right(){return this.x+this.width}set bottom(t){t<=this.y?this.height=0:this.height=t-this.y}get bottom(){return this.y+this.height}contains(t,e){const{x:r,y:i,width:s,height:n}=this;return!(s<=0||n<=0)&&(r<=t&&r+s>=t&&i<=e&&i+n>=e)}}class q{constructor(){this.name="",this.type="GameObject",this.willRender=!0,this.willUpdate=!0,this.dirtyRender=!0,this.dirtyUpdate=!0,this.dirtyFrame=0,this.isParent=!1,this.visible=!0,this.inputEnabled=!1,this.inputEnabledChildren=!0,this.fixBounds=!1,this.bounds=new H}isRenderable(){return this.visible&&this.willRender}setDirtyRender(t=!0){this.dirtyRender=!0;const e=this.scene;return t&&e&&(this.dirtyFrame=e.game.frame),this}setDirtyUpdate(){return this.dirtyUpdate=!0,this}getBounds(t=!1){return this.bounds}setBounds(t,e,r,i){return this.bounds.set(t,e,r,i),this}update(){}updateTransform(){return this}render(){}destroy(t){this.scene=null}}var $=0,K=1,Z=2,J=3,Q=4,tt=5,et=6,rt=7,it=8;class st{constructor(t=1,e=0,r=0,i=1,s=0,n=0){this.set(t,e,r,i,s,n)}set(t=1,e=0,r=0,i=1,s=0,n=0){return this.a=t,this.b=e,this.c=r,this.d=i,this.tx=s,this.ty=n,this}identity(){return this.set()}toArray(){return[this.a,this.b,this.c,this.d,this.tx,this.ty]}fromArray(t){return this.set(t[0],t[1],t[2],t[3],t[4],t[5])}[Symbol.iterator](){return this.toArray()[Symbol.iterator]()}}function nt(t,e){return e.set(t.a,t.b,t.c,t.d,t.tx,t.ty)}class at extends q{constructor(t=0,e=0){super();const r=Float32Array.BYTES_PER_ELEMENT,i=new ArrayBuffer(10*r);this.transformBuffer=i,this.transformData=new Float32Array(i,0,10),this.localTransform=new st,this.worldTransform=new st,this.transformData.set([t,e,.5,.5,0,0,1,1,0,0]),this.width=0,this.height=0,this.updateCache()}updateCache(){const t=this.localTransform,{rotation:e,skewX:r,skewY:i,scaleX:s,scaleY:n,x:a,y:o}=this;return t.set(Math.cos(e+i)*s,Math.sin(e+i)*s,-Math.sin(e-r)*n,Math.cos(e-r)*n,a,o),this.updateTransform()}updateTransform(){this.setDirtyRender();const t=this.parent,e=this.localTransform,r=this.worldTransform;if(e.tx=this.x,e.ty=this.y,!t)return nt(e,r),this;const{a:i,b:s,c:n,d:a,tx:o,ty:h}=e,{a:u,b:c,c:d,d:l,tx:f,ty:m}=t.worldTransform;return r.set(i*u+s*d,i*c+s*l,n*u+a*d,n*c+a*l,o*u+h*d+f,o*c+h*l+m),this}setSize(t,e){return this.width=t,this.height=e,this}setOrigin(t,e=t){const r=this.transformData;return r[Z]=t,r[J]=e,this}setPosition(t,e=t){const r=this.transformData;return r[$]=t,r[K]=e,this.updateTransform()}setRotation(t){const e=this.transformData;return t!==e[it]&&(e[it]=t,this.updateCache()),this}setScale(t,e=t){const r=this.transformData;return r[et]=t,r[rt]=e,this.updateCache()}setSkew(t,e=t){const r=this.transformData;return r[Q]=t,r[tt]=e,this.updateCache()}destroy(){super.destroy(),this.localTransform=null,this.worldTransform=null,this.transformBuffer=null,this.transformData=null}set x(t){this.transformData[$]=t,this.updateTransform()}get x(){return this.transformData[$]}set y(t){this.transformData[K]=t,this.updateTransform()}get y(){return this.transformData[K]}get originX(){return this.transformData[Z]}set originX(t){this.transformData[Z]=t}get originY(){return this.transformData[J]}set originY(t){this.transformData[J]=t}set skewX(t){const e=this.transformData;t!==e[Q]&&(e[Q]=t,this.updateCache())}get skewX(){return this.transformData[Q]}set skewY(t){const e=this.transformData;t!==e[tt]&&(e[tt]=t,this.updateCache())}get skewY(){return this.transformData[tt]}set scaleX(t){const e=this.transformData;t!==e[et]&&(e[et]=t,this.updateCache())}get scaleX(){return this.transformData[et]}set scaleY(t){const e=this.transformData;t!==e[rt]&&(e[rt]=t,this.updateCache())}get scaleY(){return this.transformData[rt]}set rotation(t){const e=this.transformData;t!==e[it]&&(e[it]=t,this.updateCache())}get rotation(){return this.transformData[it]}}class ot extends at{constructor(t=0,e=0){super(t,e),this._alpha=1,this.children=[],this.isParent=!0,this.type="Container"}update(t,e){const r=this.children;for(let i=0;i<r.length;i++){let s=r[i];s&&s.willUpdate&&s.update(t,e)}}destroy(t){this.children=null,super.destroy()}get numChildren(){return this.children.length}get alpha(){return this._alpha}set alpha(t){t!==this._alpha&&(this._alpha=t,this.setDirtyRender())}}class ht{constructor(t,e,r,i,s,n){this.trimmed=!1,this.texture=t,this.key=e,this.x=r,this.y=i,this.width=s,this.height=n,this.sourceSizeWidth=s,this.sourceSizeHeight=n,this.updateUVs()}setPivot(t,e){this.pivot={x:t,y:e}}setSize(t,e){this.width=t,this.height=e,this.sourceSizeWidth=t,this.sourceSizeHeight=e,this.updateUVs()}setSourceSize(t,e){this.sourceSizeWidth=t,this.sourceSizeHeight=e}setTrim(t,e,r,i,s,n){this.trimmed=!0,this.sourceSizeWidth=t,this.sourceSizeHeight=e,this.spriteSourceSizeX=r,this.spriteSourceSizeY=i,this.spriteSourceSizeWidth=s,this.spriteSourceSizeHeight=n}updateUVs(){const{x:t,y:e,width:r,height:i}=this,s=this.texture.width,n=this.texture.height;this.u0=t/s,this.v0=e/n,this.u1=(t+r)/s,this.v1=(e+i)/n}}let ut;var ct={get:function(){return ut},set:function(t){ut=t}};function dt(t){const e=ct.get();e.isTexture(t)&&e.deleteTexture(t)}function lt(t,e,r,i=!0,s=!0){const n=ct.get(),a=n.createTexture();n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,a),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t?(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),e=t.width,r=t.height):n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,r,0,n.RGBA,n.UNSIGNED_BYTE,null);const o=s?n.LINEAR:n.NEAREST;n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o);const h=t&&function(t,e){return!(t<1||e<1)&&(0==(t&t-1)&&0==(e&e-1))}(e,r),u=h&&i?n.REPEAT:n.CLAMP_TO_EDGE;return n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,u),h&&n.generateMipmap(n.TEXTURE_2D),a}class ft{constructor(t,e,r){this.key="",this.glIndex=0,this.glIndexCounter=-1,t&&(e=t.width,r=t.height),this.image=t,this.width=e,this.height=r,this.frames=new Map,this.data={},this.add("__BASE",0,0,e,r)}add(t,e,r,i,s){if(this.frames.has(t))return null;let n=new ht(this,t,e,r,i,s);return this.frames.set(t,n),this.firstFrame&&"__BASE"!==this.firstFrame.key||(this.firstFrame=n),n}get(t){if(!t)return this.firstFrame;t instanceof ht&&(t=t.key);let e=this.frames.get(t);return e||(console.warn("Texture.frame missing: "+t),e=this.firstFrame),e}getFrames(t){const e=[];return t.forEach(t=>{e.push(this.get(t))}),e}getFramesInRange(t,e,r,i=0,s=""){const n=[],a=e<r?1:-1;r+=a;for(let o=e;o!==r;o+=a)n.push(t+o.toString().padStart(i,"0")+s);return this.getFrames(n)}setSize(t,e){this.width=t,this.height=e,this.frames.get("__BASE").setSize(t,e)}setFilter(t){!function(t,e=!0){const r=ct.get();r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t);const i=e?r.LINEAR:r.NEAREST;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i)}(this.glTexture,t)}createGL(){this.glTexture&&dt(this.glTexture),this.glTexture=lt(this.image)}updateGL(){this.glTexture?function(t,e,r=!1){const i=ct.get(),s=t.width,n=t.height;s>0&&n>0&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t))}(this.image,this.glTexture):this.glTexture=lt(this.image)}destroy(){this.frames.clear(),this.image=null,this.firstFrame=null,this.data=null,dt(this.glTexture),function(t){const e=ct.get();e.isFramebuffer(t)&&e.deleteFramebuffer(t)}(this.glFramebuffer)}}let mt;var xt={get:function(){return mt},set:function(t){mt=t}};function gt(t,...e){e.forEach(e=>{let r=e.texture.get(t);if(r===e.frame)return;e.frame=r,e.setSize(r.sourceSizeWidth,r.sourceSizeHeight),e.setBounds(e.x,e.y,e.width,e.height),r.pivot&&e.setOrigin(r.pivot.x,r.pivot.y);let i=e.vertexData;i[2]=r.u0,i[3]=r.v0,i[8]=r.u0,i[9]=r.v1,i[14]=r.u1,i[15]=r.v1,i[20]=r.u1,i[21]=r.v0,e.setDirtyRender(),e.hasTexture=!0})}var pt={Container:ot,GameObject:q,Sprite:class extends ot{constructor(t,e,r,i){super(t,e),this.hasTexture=!1,this._tint=16777215,this._prevTextureID=-1,this.vertexData=new Float32Array(24).fill(0),this.vertexColor=new Uint32Array(4).fill(4294967295),this.vertexAlpha=new Float32Array(4).fill(1),this.vertexTint=new Uint32Array(4).fill(16777215),this.type="Sprite",this.setTexture(r,i),this.setBounds(t,e,this.width,this.height)}getBounds(t=!1){return this.dirtyRender&&this.updateVertices(),super.getBounds(t),this.bounds}setTexture(t,e){return function(t,e,...r){r.forEach(r=>{t&&(r.texture=t instanceof ft?t:xt.get().textures.get(t),r.texture?gt(e,r):console.warn("Invalid Texture key: "+t))})}(t,e,this),this}setFrame(t){return gt(t,this),this}isRenderable(){return this.visible&&this.willRender&&this.hasTexture&&this.alpha>0}updateVertices(){const t=this.vertexData;this.dirtyRender=!1;const e=this.frame,r=this.originX,i=this.originY;let s,n,a,o;const[h,u,c,d,l,f]=this.worldTransform;e.trimmed?(n=e.spriteSourceSizeX-r*e.sourceSizeWidth,s=n+e.spriteSourceSizeWidth,o=e.spriteSourceSizeY-i*e.sourceSizeHeight,a=o+e.spriteSourceSizeHeight):(n=-r*e.sourceSizeWidth,s=n+e.sourceSizeWidth,o=-i*e.sourceSizeHeight,a=o+e.sourceSizeHeight);const m=n*h+o*c+l,x=n*u+o*d+f,g=n*h+a*c+l,p=n*u+a*d+f,y=s*h+a*c+l,T=s*u+a*d+f,b=s*h+o*c+l,w=s*u+o*d+f;t[0]=m,t[1]=x,t[6]=g,t[7]=p,t[12]=y,t[13]=T,t[18]=b,t[19]=w;const v=this.bounds;v.x=Math.min(m,g,y,b),v.y=Math.min(x,p,T,w),v.right=Math.max(m,g,y,b),v.bottom=Math.max(x,p,T,w)}uploadBuffers(t,e,r,i=!0){this.dirtyRender&&this.updateVertices();const s=this.vertexData,n=this.texture.glIndex;i&&n!==this._prevTextureID&&(this._prevTextureID=n,s[4]=n,s[10]=n,s[16]=n,s[22]=n),t.set(s,r);const a=this.vertexColor;e[r+5]=a[0],e[r+11]=a[2],e[r+17]=a[3],e[r+23]=a[1]}destroy(t){super.destroy(t),this.texture=null,this.frame=null,this.hasTexture=!1,this.vertexData=null,this.vertexColor=null,this.vertexAlpha=null,this.vertexTint=null}get tint(){return this._tint}set tint(t){this._tint=t}}},yt=Object.freeze({__proto__:null,default:pt});class Tt{constructor(t=0,e=0){this.set(t,e)}set(t=0,e=0){return this.x=t,this.y=e,this}zero(){return this.set()}getArray(){return[this.x,this.y]}fromArray(t){return this.set(t[0],t[1])}[Symbol.iterator](){return this.getArray()[Symbol.iterator]()}}var bt={Add:function(t,e){return t.a+=e.a,t.b+=e.b,t.c+=e.c,t.d+=e.d,t.tx+=e.tx,t.ty+=e.ty,t},Copy:nt,CopyToContext:function(t,e){const{a:r,b:i,c:s,d:n,tx:a,ty:o}=t;return e.transform(r,i,s,n,a,o),e},Determinant:function(t){const{a:e,b:r,c:i,d:s}=t;return e*s-r*i},Frobenius:function(t){return Math.hypot(t.a,t.b,t.c,t.d,t.tx,t.ty,1)},GlobalToLocal:function(t,e,r,i=new Tt){const{a:s,b:n,c:a,d:o,tx:h,ty:u}=t,c=1/(s*o+a*-n);return i.x=o*c*e+-a*c*r+(u*a-h*o)*c,i.y=s*c*r+-n*c*e+(-u*s+h*n)*c,i},Invert:function(t){const{a:e,b:r,c:i,d:s,tx:n,ty:a}=t;let o=e*s-r*i;return o&&(o=1/o,t.set(s*o,-r*o,-i*o,e*o,(i*a-s*n)*o,(r*n-e*a)*o)),t},ITRS:function(t,e,r,i,s,n){if(0===i)return t.set(1,0,0,1,e,r);{const a=Math.sin(i),o=Math.cos(i);return t.set(o*s,a*s,-a*n,o*n,e,r)}},ITRSS:function(t,e,r,i=0,s=1,n=1,a=0,o=0){if(0===i)return t.set(1,0,0,1,e,r);{const a=Math.sin(i),o=Math.cos(i);return t.set(o*s,a*s,-a*n,o*n,e,r)}},LocalToGlobal:function(t,e,r,i=new Tt){const{a:s,b:n,c:a,d:o,tx:h,ty:u}=t;return i.x=s*e+a*r+h,i.y=n*e+o*r+u,i},Matrix2D:st,Multiply:function(t,e){const{a:r,b:i,c:s,d:n,tx:a,ty:o}=t,{a:h,b:u,c:c,d:d,tx:l,ty:f}=e;return t.a=r*h+s*u,t.b=i*h+n*u,t.c=r*c+s*d,t.d=i*c+n*d,t.tx=r*l+s*f+a,t.ty=i*l+n*f+o,t},MultiplyScalar:function(t,e){return t.a*=e,t.b*=e,t.c*=e,t.d*=e,t.tx*=e,t.ty*=e,t},MultiplyScalarAndAdd:function(t,e,r){const{a:i,b:s,c:n,d:a,tx:o,ty:h}=e;return t.a+=i*r,t.b+=s*r,t.c+=n*r,t.d+=a*r,t.tx+=o*r,t.ty+=h*r,t},Rotate:function(t,e){const{a:r,b:i,c:s,d:n,tx:a,ty:o}=t,h=Math.sin(e),u=Math.cos(e);return t.set(r*u+s*h,i*u+n*h,r*-h+s*u,i*-h+n*u,a,o)},Scale:function(t,e,r){return t.a*=e,t.b*=e,t.c*=r,t.d*=r,t},SetToContext:function(t,e){const{a:r,b:i,c:s,d:n,tx:a,ty:o}=t;return e.setTransform(r,i,s,n,a,o),e},Skew:function(t,e,r){return t.b+=Math.tan(e),t.c+=Math.tan(r),t},Subtract:function(t,e){const{a:r,b:i,c:s,d:n,tx:a,ty:o}=e;return t.a-=r,t.b-=i,t.c-=s,t.d-=n,t.tx-=a,t.ty-=o,t},Translate:function(t,e,r){const{a:i,b:s,c:n,d:a,tx:o,ty:h}=t;return t.tx=i*e+n*r+o,t.ty=s*e+a*r+h,t},Zero:function(t){return t.set(0,0,0,0,0,0)}};function wt(t,e){return t.a===e.a&&t.b===e.b&&t.c===e.c&&t.d===e.d&&t.tx===e.tx&&t.ty===e.ty}function vt(t,e){const{a:r,b:i,c:s,d:n}=t,a=Math.sin(e),o=Math.cos(e);return new st(r*o+s*a,i*o+n*a,r*-a+s*o,i*-a+n*o)}function St(t,e,r){return new st(t.a*e,t.b*e,t.c*r,t.d*r)}function Et(t,e,r){const{a:i,b:s,c:n,d:a,tx:o,ty:h}=t;return new st(1,0,0,1,i*e+n*r+o,s*e+a*r+h)}var At={Add:function(t,e){return new st(t.a+e.a,t.b+e.b,t.c+e.c,t.c+e.c,t.tx+e.tx,t.ty+e.ty)},Append:function(t,e,r=new st){const{a:i,b:s,c:n,d:a,tx:o,ty:h}=t,{a:u,b:c,c:d,d:l,tx:f,ty:m}=e;return r.set(u*i+c*n,u*s+c*a,d*i+l*n,d*s+l*a,f*i+m*n+o,f*s+m*a+h)},Clone:function(t){return new st(t.a,t.b,t.c,t.d,t.tx,t.ty)},Equals:function(t,e,r=1e-6){const{a:i,b:s,c:n,d:a,tx:o,ty:h}=t,{a:u,b:c,c:d,d:l,tx:f,ty:m}=e;return Math.abs(i-u)<=r*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(s-c)<=r*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(n-d)<=r*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-l)<=r*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(o-f)<=r*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(h-m)<=r*Math.max(1,Math.abs(h),Math.abs(m))},ExactEquals:wt,FromRotation:function(t){return vt(new st,t)},FromScaling:function(t,e=t){return St(new st,t,e)},FromTranslation:function(t,e){return Et(new st,t,e)},Identity:function(){return new st},Invert:function(t){const{a:e,b:r,c:i,d:s,tx:n,ty:a}=t;let o=e*s-r*i;return o?(o=1/o,new st(s*o,-r*o,-i*o,e*o,(i*a-s*n)*o,(r*n-e*a)*o)):null},Multiply:function(t,e){const{a:r,b:i,c:s,d:n,tx:a,ty:o}=t,{a:h,b:u,c:c,d:d,tx:l,ty:f}=e;return new st(r*h+s*u,i*h+n*u,r*c+s*d,i*c+n*d,r*l+s*f+a,i*l+n*f+o)},MultiplyScalar:function(t,e){return new st(t.a*e,t.b*e,t.c*e,t.d*e,t.tx*e,t.ty*e)},MultiplyScalarAndAdd:function(t,e,r){return new st(t.a+e.a*r,t.b+e.b*r,t.c+e.c*r,t.d+e.d*r,t.tx+e.tx*r,t.ty+e.ty*r)},Rotate:vt,Scale:St,Subtract:function(t,e){return new st(t.a-e.a,t.b-e.b,t.c-e.c,t.c-e.c,t.tx-e.tx,t.ty-e.ty)},Translate:Et,Zero:function(){return new st(0,0,0,0,0,0)}},Rt={Vec2:Tt},_t={Between:function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},FloatBetween:function(t,e){return Math.random()*(e-t)+t},Matrix2d:Object.freeze({__proto__:null,default:bt}),Matrix2dFuncs:Object.freeze({__proto__:null,default:At}),Vec2:Object.freeze({__proto__:null,default:Rt})},Mt=Object.freeze({__proto__:null,default:_t});function Ft(t,e){const r=document.createElement("canvas");return r.width=t,r.height=e,r.getContext("2d")}function Pt(t,e,r,i){const s=t.texture;s.glIndexCounter<i&&e.requestTexture(s),r.count===r.batchSize&&r.flush(),t.uploadBuffers(r.vertexViewF32,r.vertexViewU32,r.count*r.quadElementSize),r.count++}function Ct(t,e,r=-1,i=1){return new Float32Array([1/-t*-2,0,0,0,0,1/e*-2,0,0,0,0,1/(r-i)*2,0,-1,1,0,1])}class Dt{constructor(){this.textures=new Map,this.createDefaultTextures()}createDefaultTextures(){this.add("__BLANK",new ft(Ft(32,32).canvas));const t=Ft(32,32);t.strokeStyle="#0f0",t.moveTo(0,0),t.lineTo(32,32),t.stroke(),t.strokeRect(.5,.5,31,31),this.add("__MISSING",new ft(t.canvas))}get(t){return this.textures.has(t)?this.textures.get(t):this.textures.get("__MISSING")}has(t){return this.textures.has(t)}add(t,e){let r;return this.textures.has(t)||(r=e instanceof ft?e:new ft(e),r.key=t,r.glTexture||r.createGL(),this.textures.set(t,r)),r}}var Ot={AtlasParser:function(t,e){let r;if(Array.isArray(e.textures)?r=e.textures[0].frames:Array.isArray(e.frames)?r=e.frames:e.hasOwnProperty("frames")?r=Object.values(e.frames):console.warn("Invalid Texture Atlas JSON"),r){let e;for(let i=0;i<r.length;i++){let s=r[i];e=t.add(s.filename,s.frame.x,s.frame.y,s.frame.w,s.frame.h),s.trimmed?e.setTrim(s.sourceSize.w,s.sourceSize.h,s.spriteSourceSize.x,s.spriteSourceSize.y,s.spriteSourceSize.w,s.spriteSourceSize.h):e.setSourceSize(s.sourceSize.w,s.sourceSize.h),s.rotated,s.anchor&&e.setPivot(s.anchor.x,s.anchor.y)}}},CanvasTexture:function(t=32,e=32){const r=Ft(t,e);return new ft(r.canvas)},CreateCanvas:Ft,Frame:ht,GridTexture:function(t,e,r=32,i=32,s=2,n=2){const a=Ft(r,i),o=r/s,h=i/n;a.fillStyle=t,a.fillRect(0,0,r,i),a.fillStyle=e;for(let t=0;t<n;t++)for(let e=t%2;e<s;e+=2)a.fillRect(e*o,t*h,o,h);return new ft(a.canvas)},RenderTexture:class extends ft{constructor(t,e=256,r=e){super(null,e,r),this.renderer=t;const[i,s]=function(t,e){const r=ct.get(),i=lt(null,t,e),s=r.createFramebuffer();return r.bindFramebuffer(r.FRAMEBUFFER,s),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,i,0),r.bindFramebuffer(r.FRAMEBUFFER,null),[i,s]}(e,r);this.glTexture=i,this.glFramebuffer=s,this.projectionMatrix=Ct(e,r),this.cameraMatrix=new Float32Array([1,0,0,0,0,-1,0,0,0,0,1,0,0,r,0,1])}cls(){const t=this.renderer,e=t.gl;return t.reset(this.glFramebuffer,this.width,this.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),t.reset(),this}batchStart(){const t=this.renderer;return t.reset(this.glFramebuffer,this.width,this.height),t.shader.bind(this.projectionMatrix,this.cameraMatrix),this}batchDraw(...t){const e=this.renderer,r=e.shader;for(let i=0;i<t.length;i++)Pt(t[i],e,r,e.startActiveTexture);return this}batchEnd(){const t=this.renderer;return t.shader.flush(),t.reset(),this}draw(...t){return this.batchStart(),this.batchDraw(...t),this.batchEnd(),this}},SolidColorTexture:function(t="rgba(0,0,0,0)",e=32,r=32){const i=Ft(e,r);return i.fillStyle=t,i.fillRect(0,0,e,r),new ft(i.canvas)},SpriteSheetParser:function(t,e,r,i,s,n){let{frameWidth:a=null,frameHeight:o=null,startFrame:h=0,endFrame:u=-1,margin:c=0,spacing:d=0}=n;if(o||(o=a),null===a)throw new Error("SpriteSheetParser: Invalid frameWidth");let l=Math.floor((i-c+d)/(a+d))*Math.floor((s-c+d)/(o+d));0===l&&console.warn("SpriteSheetParser: Frame config will result in zero frames"),(h>l||h<-l)&&(h=0),h<0&&(h=l+h),-1!==u&&(l=h+(u+1));let f=c,m=c,x=0,g=0;for(let n=0;n<l;n++){x=0,g=0;let h=f+a,u=m+o;h>i&&(x=h-i),u>s&&(g=u-s),t.add(n,e+f,r+m,a-x,o-g),f+=a+d,f+a>i&&(f=c,m+=o+d)}},Texture:ft,TextureManager:Dt},zt=Object.freeze({__proto__:null,default:Ot});const Lt=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join("\n");function Bt(t){let e="";for(let r=0;r<t;++r)r>0&&(e+="\nelse "),r<t-1&&(e+=`if(test == ${r}.0){}`);return e}const Ut={fragmentShader:"\nprecision highp float;\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vTintColor;\nuniform sampler2D uTexture[%count%];\nvoid main (void)\n{\n    vec4 color;\n    %forloop%\n    gl_FragColor = color * vec4(vTintColor.bgr * vTintColor.a, vTintColor.a);\n}",vertexShader:"\nprecision highp float;\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute float aTextureId;\nattribute vec4 aTintColor;\nuniform mat4 uProjectionMatrix;\nuniform mat4 uCameraMatrix;\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vTintColor;\nvoid main (void)\n{\n    vTextureCoord = aTextureCoord;\n    vTextureId = aTextureId;\n    vTintColor = aTintColor;\n    gl_Position = uProjectionMatrix * uCameraMatrix * vec4(aVertexPosition, 0.0, 1.0);\n}"};class It{constructor(t,e={}){this.attribs={aVertexPosition:0,aTextureCoord:0,aTextureId:0,aTintColor:0},this.uniforms={uProjectionMatrix:0,uCameraMatrix:0,uTexture:0},this.dataSize=4,this.indexSize=4,this.vertexElementSize=6,this.vertexByteSize=24,this.quadByteSize=96,this.quadElementSize=24,this.quadIndexSize=6,this.renderer=t,this.gl=t.gl;const{batchSize:r=4096,fragmentShader:i=Ut.fragmentShader,vertexShader:s=Ut.vertexShader}=e;this.batchSize=r,this.bufferByteSize=r*this.quadByteSize,this.createBuffers(),this.createShaders(i,s),this.count=0}createBuffers(){let t=[];for(let e=0;e<this.batchSize*this.indexSize;e+=this.indexSize)t.push(e+0,e+1,e+2,e+2,e+3,e+0);this.data=new ArrayBuffer(this.bufferByteSize),this.index=new Uint16Array(t),this.vertexViewF32=new Float32Array(this.data),this.vertexViewU32=new Uint32Array(this.data);const e=this.gl;this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.data,e.DYNAMIC_DRAW),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.index,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),t=[]}createShaders(t,e){const r=this.gl,i=this.renderer.maxTextures;let s="";if(i>1){for(let t=0;t<i;t++)t>0&&(s+="\nelse "),t<i-1&&(s+=`if (vTextureId < ${t}.5)`),s+="\n{",s+=`\n  color = texture2D(uTexture[${t}], vTextureCoord);`,s+="\n}";t=(t=t.replace(/%count%/gi,""+i)).replace(/%forloop%/gi,s)}else s="color = texture2D(uTexture[0], vTextureCoord);";const n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(n,t),r.compileShader(n);const a=r.createShader(r.VERTEX_SHADER);r.shaderSource(a,e),r.compileShader(a);const o=r.createProgram();r.attachShader(o,a),r.attachShader(o,n),r.linkProgram(o),r.useProgram(o),this.program=o;for(let t of Object.keys(this.attribs)){let e=r.getAttribLocation(o,t);r.enableVertexAttribArray(e),this.attribs[t]=e}for(let t of Object.keys(this.uniforms))this.uniforms[t]=r.getUniformLocation(o,t)}bind(t,e){const r=this.gl,i=this.renderer,s=this.uniforms;r.useProgram(this.program),r.uniformMatrix4fv(s.uProjectionMatrix,!1,t),r.uniformMatrix4fv(s.uCameraMatrix,!1,e),r.uniform1iv(s.uTexture,i.textureIndex),this.bindBuffers(this.indexBuffer,this.vertexBuffer)}bindBuffers(t,e){const r=this.gl,i=this.vertexByteSize,s=this.attribs;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),r.bindBuffer(r.ARRAY_BUFFER,e),r.vertexAttribPointer(s.aVertexPosition,2,r.FLOAT,!1,i,0),r.vertexAttribPointer(s.aTextureCoord,2,r.FLOAT,!1,i,8),r.vertexAttribPointer(s.aTextureId,1,r.FLOAT,!1,i,16),r.vertexAttribPointer(s.aTintColor,4,r.UNSIGNED_BYTE,!0,i,20),this.count=0}draw(t){const e=this.gl,r=t*this.quadByteSize;if(r===this.bufferByteSize)e.bufferData(e.ARRAY_BUFFER,this.data,e.DYNAMIC_DRAW);else{let t=this.vertexViewF32.subarray(0,r);e.bufferSubData(e.ARRAY_BUFFER,0,t)}e.drawElements(e.TRIANGLES,t*this.quadIndexSize,e.UNSIGNED_SHORT,0)}flush(){const t=this.count;return 0!==t&&(this.draw(t),this.prevCount=t,this.count=0,this.renderer.flushTotal++,!0)}}class Vt{constructor(t,e,r){this.contextOptions={alpha:!1,antialias:!1,premultipliedAlpha:!1,stencil:!1,preserveDrawingBuffer:!1,desynchronized:!1},this.clearColor=[0,0,0,1],this.flushTotal=0,this.maxTextures=0,this.currentActiveTexture=0,this.startActiveTexture=0,this.tempTextures=[],this.clearBeforeRender=!0,this.optimizeRedraw=!0,this.autoResize=!0,this.contextLost=!1,this.width=t,this.height=e,this.resolution=r;const i=document.createElement("canvas");i.addEventListener("webglcontextlost",t=>this.onContextLost(t),!1),i.addEventListener("webglcontextrestored",()=>this.onContextRestored(),!1),this.canvas=i,this.initContext(),this.shader=new It(this)}initContext(){const t=this.canvas.getContext("webgl",this.contextOptions);ct.set(t),this.gl=t,this.elementIndexExtension=t.getExtension("OES_element_index_uint"),this.getMaxTextures(),this.shader&&(this.shader.gl=t),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),this.resize(this.width,this.height,this.resolution)}resize(t,e,r=1){this.width=t*r,this.height=e*r,this.resolution=r;const i=this.canvas;i.width=this.width,i.height=this.height,this.autoResize&&(i.style.width=this.width/r+"px",i.style.height=this.height/r+"px"),this.gl.viewport(0,0,this.width,this.height),this.projectionMatrix=Ct(t,e)}onContextLost(t){t.preventDefault(),this.contextLost=!0}onContextRestored(){this.contextLost=!1,this.initContext()}setBackgroundColor(t){const e=this.clearColor,r=t>>16&255,i=t>>8&255,s=255&t,n=t>16777215?t>>>24:255;return e[0]=r/255,e[1]=i/255,e[2]=s/255,e[3]=n/255,this}getMaxTextures(){const t=this.gl;let e=function(t,e){const r=e.createShader(e.FRAGMENT_SHADER);for(;;){const i=Lt.replace(/%forloop%/gi,Bt(t));if(e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))break;t=t/2|0}return t}(t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t);const r=this.tempTextures;r.length&&r.forEach(e=>{t.deleteTexture(e)});for(let i=0;i<e;i++){let e=t.createTexture();t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),r[i]=e}this.maxTextures=e,this.textureIndex=Array.from(Array(e).keys()),this.activeTextures=Array(e),this.currentActiveTexture=0}reset(t=null,e=this.width,r=this.height){const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,t),i.viewport(0,0,e,r),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),this.currentActiveTexture=0,this.startActiveTexture++,this.flushTotal=0}render(t,e,r){if(this.contextLost)return;const i=this.gl;this.flushTotal;if(this.reset(),this.optimizeRedraw&&0===e&&0===r)return;const s=this.shader,n=this.clearColor;this.clearBeforeRender&&(i.clearColor(n[0],n[1],n[2],n[3]),i.clear(i.COLOR_BUFFER_BIT));const a=this.projectionMatrix;let o;for(let e=0;e<t.length;e+=2){let r=t[e],i=t[e+1];o&&wt(r.worldTransform,o.worldTransform)||(s.flush(),s.bind(a,r.matrix),o=r);for(let t=0;t<i.length;t++)Pt(i[t],this,s,this.startActiveTexture)}s.flush()}resetTextures(t){const e=this.gl,r=this.activeTextures;r.fill(null),this.currentActiveTexture=0,this.startActiveTexture++,t&&(r[0]=t,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t.glTexture),this.currentActiveTexture=1)}requestTexture(t){const e=this.gl;t.glIndexCounter=this.startActiveTexture,this.currentActiveTexture<this.maxTextures?(this.activeTextures[this.currentActiveTexture]=t,t.glIndex=this.currentActiveTexture,e.activeTexture(e.TEXTURE0+this.currentActiveTexture),e.bindTexture(e.TEXTURE_2D,t.glTexture),this.currentActiveTexture++):(this.shader.flush(),this.resetTextures(t))}}function kt(t,e,r){return t.hasOwnProperty(e)?t[e]:r}class Gt{constructor(t){this.sceneIndex=0,this.flush=!1,this.dirtyCameras=0,this.dirtyFrame=0,this.totalFrame=0,this.game=t,this.scenes=new Map,this.renderList=[]}boot(t){t.forEach(t=>{this.add(t)})}add(t){const e=new t;e.willUpdate&&e.boot.call(e)}init(t,e={}){const r=this.scenes.size,i=this.sceneIndex,s=0===r;"string"==typeof e?t.key=e:(e||!e&&s)&&(t.key=kt(e,"key","scene"+i),t.willUpdate=kt(e,"willUpdate",s),t.willRender=kt(e,"willRender",s)),this.scenes.has(t.key)?console.warn("Scene key already in use: "+t.key):(this.scenes.set(t.key,t),this.flush=!0,this.sceneIndex++)}update(t,e){for(const r of this.scenes.values())r.willUpdate&&(r.update.call(r,t,e),r.world.update(t,e))}render(t){const e=this.renderList;e.length=0,this.dirtyCameras=0,this.dirtyFrame=0,this.totalFrame=0;for(let r of this.scenes.values())if(r.willRender){let i=r.world;if(this.dirtyFrame+=i.render(t),this.totalFrame+=i.totalFrame,0===i.renderList.length)continue;i.camera.dirtyRender&&(this.dirtyCameras++,i.camera.dirtyRender=!1),e.push(i.camera),e.push(i.renderList)}return this.flush&&(this.dirtyFrame++,this.flush=!1),[e,this.dirtyFrame,this.dirtyCameras]}}class Nt{constructor(t,e,r=!1){this.callback=t,this.context=e,this.once=r}}class Xt{constructor(){this._events=new Map}on(t,e,r=this,i=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const s=new Nt(e,r,i),n=this._events.get(t);return n?n.add(s):this._events.set(t,new Set([s])),this}once(t,e,r=this){return this.on(t,e,r,!0)}clearEvent(t){return this._events.delete(t),this}eventNames(){return[...this._events.keys()]}listeners(t){const e=[];return this._events.get(t).forEach(t=>{e.push(t.callback)}),e}listenerCount(t){const e=this._events.get(t);return e?e.size:0}emit(t,...e){if(!this._events.has(t))return!1;const r=this._events.get(t);for(const t of r)t.callback.apply(t.context,e),t.once&&r.delete(t);return 0===r.size&&this._events.delete(t),!0}off(t,e,r,i){if(e){const s=this._events.get(t),n=!r,a=void 0!==i;for(const t of s)t.callback===e&&n&&t.context===console&&a&&t.once===i&&s.delete(t);0===s.size&&this._events.delete(t)}else this._events.delete(t);return this}removeAllListeners(t){t?this._events.delete(t):this._events.clear()}}class Wt extends at{constructor(t=0,e=0){super(t,e),this.type="Camera";const r=xt.get();this.renderer=r.renderer,this.reset()}updateTransform(){if(!this.renderer)return this;this.dirtyRender=!0;const t=this.localTransform,e=this.worldTransform;t.tx=0-this.x,t.ty=0-this.y;const r=this.matrix,{a:i,b:s,c:n,d:a,tx:o,ty:h}=t,u=this.renderer.width*this.originX,c=this.renderer.height*this.originY;r[0]=i,r[1]=s,r[4]=n,r[5]=a;const d=i*-u+n*-c+(u+o),l=s*-u+a*-c+(c+h);return r[12]=d,r[13]=l,e.set(i,s,n,a,d,l),this.bounds.x=-1*d,this.bounds.y=-1*l,this}reset(){this.matrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);const t=this.renderer.width,e=this.renderer.height;this.setSize(t,e),this.setBounds(0,0,t,e)}destroy(){super.destroy(),this.renderer=null,this.matrix=null}}class jt{constructor(t){this.dirtyFrame=0,this.totalFrame=0,this.visibleFrame=0,this.boundsFrame=0,this.forceRefresh=!1,this.enableCameraCull=!0,this.scene=t,this.children=[],this.renderList=[],this.worldTransform=new st,this.camera=new Wt}scanChildren(t,e){const r=t.children;for(let t=0;t<r.length;t++)this.buildRenderList(r[t],e)}buildRenderList(t,e){if(t.isRenderable()){const s=this.enableCameraCull;s&&(!s||(r=t.getBounds(),i=this.camera.bounds,r.width<=0||r.height<=0||i.width<=0||i.height<=0||r.right<i.x||r.bottom<i.y||r.x>i.right||r.y>i.bottom))||(this.renderList.push(t),t.dirtyFrame>=e&&this.dirtyFrame++),this.visibleFrame++}var r,i;t.isParent&&t.visible&&this.scanChildren(t,e)}update(t,e){const r=this.children;for(let i=0;i<r.length;i++){let s=r[i];s&&s.willUpdate&&s.update(t,e)}}render(t){return this.dirtyFrame=0,this.boundsFrame=0,this.visibleFrame=0,this.renderList.length=0,this.scanChildren(this,t),this.totalFrame=this.renderList.length,this.forceRefresh&&(this.dirtyFrame++,this.forceRefresh=!1),this.dirtyFrame}shutdown(){this.renderList=[],this.camera.reset()}destroy(){this.camera.destroy(),this.camera=null,this.renderList=null}get numChildren(){return this.children.length}}class Yt{constructor(t){this.scene=t,this.renderer=t.game.renderer,this.matrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.bounds=new H,this.reset()}reset(){const t=this.renderer.width,e=this.renderer.height;this.width=t,this.height=e,this.bounds.set(0,0,t,e)}destroy(){this.scene=null,this.renderer=null,this.matrix=null,this.bounds=null}}class Ht{constructor(t){this.dirtyFrame=0,this.totalFrame=0,this.visibleFrame=0,this.forceRefresh=!1,this.scene=t,this.children=[],this.renderList=[],this.worldTransform=new st,this.camera=new Yt(t)}scanChildren(t,e){const r=t.children;for(let t=0;t<r.length;t++)this.buildRenderList(r[t],e)}buildRenderList(t,e){t.isRenderable()&&(this.renderList.push(t),t.dirtyFrame>=e&&this.dirtyFrame++,this.visibleFrame++),t.isParent&&t.visible&&this.scanChildren(t,e)}update(t,e){const r=this.children;for(let i=0;i<r.length;i++){let s=r[i];s&&s.willUpdate&&s.update(t,e)}}render(t){return this.dirtyFrame=0,this.visibleFrame=0,this.renderList.length=0,this.scanChildren(this,t),this.totalFrame=this.renderList.length,this.forceRefresh&&(this.dirtyFrame++,this.forceRefresh=!1),this.dirtyFrame}shutdown(){this.renderList=[],this.camera.reset()}destroy(){this.camera.destroy(),this.camera=null,this.renderList=null}get numChildren(){return this.children.length}}t.DOM=Y,t.Device=X,t.EventEmitter=Xt,t.Game=class extends Xt{constructor(t){super(),this.VERSION="4.0.0-beta1",this.isPaused=!1,this.isBooted=!1,this.lifetime=0,this.elapsed=0,this.frame=0;const{width:e=800,height:r=600,resolution:i=1,backgroundColor:s=0,parent:n=document.body,scene:a=null}=t;this.config={width:e,height:r,resolution:i,backgroundColor:s,parent:n,scene:a},this.cache={json:new Map,csv:new Map,xml:new Map},xt.set(this),j(()=>this.boot())}pause(){this.isPaused=!0,this.emit("pause")}resume(){this.isPaused=!1,this.lastTick=Date.now(),this.emit("resume")}boot(){const t=this.config;this.isBooted=!0,this.lastTick=Date.now();const e=new Vt(t.width,t.height,t.resolution);e.setBackgroundColor(t.backgroundColor),W(e.canvas,t.parent),this.renderer=e,this.textures=new Dt,this.scenes=new Gt(this),this.banner(this.VERSION),this.scenes.boot([].concat(t.scene)),document.addEventListener("visibilitychange",()=>{this.emit("visibilitychange",document.hidden),document.hidden?this.pause():this.resume()}),this.emit("boot"),requestAnimationFrame(()=>this.step())}banner(t){console.log("%cPhaser v"+t+"%c https://phaser4.io","padding: 4px 16px; color: #fff; background: linear-gradient(#3e0081 40%, #00bcc3)","")}step(){const t=Date.now(),e=(t-this.lastTick)/1e3;this.lifetime+=e,this.elapsed=e,this.lastTick=t,this.emit("step",e,t);const r=this.scenes;this.isPaused||r.update(e,t),this.emit("update",e,t);const[i,s,n]=r.render(this.frame);this.renderer.render(i,s,n),this.emit("render",e,t),this.frame++,requestAnimationFrame(()=>this.step())}destroy(){}},t.GameObjects=yt,t.Loader=class extends Xt{constructor(){super(),this.baseURL="",this.path="",this.crossOrigin="anonymous",this.maxParallelDownloads=-1,this.isLoading=!1,this.reset()}reset(){this.isLoading=!1,this.queue=new Set,this.inflight=new Set,this.completed=new Set,this.progress=0}add(...t){return t.forEach(t=>{t.loader=this,this.queue.add(t)}),this}start(t){if(!this.isLoading)return this.completed.clear(),this.progress=0,this.queue.size>0?(this.isLoading=!0,this.onComplete=t,this.emit("start"),this.nextFile()):(this.progress=1,this.emit("complete"),t()),this}nextFile(){let t=this.queue.size;if(-1!==this.maxParallelDownloads&&(t=Math.min(t,this.maxParallelDownloads)-this.inflight.size),t){const e=this.queue.values();for(;t>0;){const r=e.next().value;this.inflight.add(r),this.queue.delete(r),r.load().then(t=>this.fileComplete(t)).catch(t=>this.fileError(t)),t--}}else 0===this.inflight.size&&this.stop()}stop(){this.isLoading=!1,this.emit("complete",this.completed),this.onComplete(),this.completed.clear()}updateProgress(t){this.inflight.delete(t),this.completed.add(t);const e=this.completed.size,r=this.queue.size+this.inflight.size;e>0&&(this.progress=e/(e+r)),this.emit("progress",this.progress,e,r),this.nextFile()}fileComplete(t){this.emit("filecomplete",t),this.updateProgress(t)}fileError(t){this.emit("fileerror",t),this.updateProgress(t)}totalFilesToLoad(){return this.queue.size+this.inflight.size}setBaseURL(t=""){return""!==t&&"/"!==t.substr(-1)&&(t=t.concat("/")),this.baseURL=t,this}setPath(t=""){return""!==t&&"/"!==t.substr(-1)&&(t=t.concat("/")),this.path=t,this}setCORS(t){return this.crossOrigin=t,this}setMaxParallelDownloads(t){return this.maxParallelDownloads=t,this}},t.Math=Mt,t.Scene=class{constructor(t){this.willUpdate=!1,this.willRender=!1,this.game=xt.get(),this.world=new jt(this),this.game.scenes.init(this,t)}boot(){}update(){}render(){}shutdown(){}destroy(){this.world.destroy(),this.world=null,this.game=null}},t.StaticScene=class{constructor(t){this.willUpdate=!1,this.willRender=!1,this.game=xt.get(),this.world=new Ht(this),this.game.scenes.init(this,t)}boot(){}update(){}render(){}shutdown(){}destroy(){this.world.destroy(),this.world=null,this.game=null}},t.Textures=zt,t.WebGLRenderer=Vt,Object.defineProperty(t,"__esModule",{value:!0})}));
