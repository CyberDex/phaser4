!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Phaser4={})}(this,(function(t){"use strict";class e{constructor(t=0,e=0,r=0,s=0){this.set(t,e,r,s)}set(t=0,e=0,r=0,s=0){return this.x=t,this.y=e,this.width=r,this.height=s,this}set right(t){t<=this.x?this.width=0:this.width=t-this.x}get right(){return this.x+this.width}set bottom(t){t<=this.y?this.height=0:this.height=t-this.y}get bottom(){return this.y+this.height}contains(t,e){const{x:r,y:s,width:i,height:n}=this;return!(i<=0||n<=0)&&(r<=t&&r+i>=t&&s<=e&&s+n>=e)}}class r{constructor(){this.name="",this.type="GameObject",this.willRender=!0,this.willUpdate=!0,this.dirtyRender=!0,this.dirtyUpdate=!0,this.dirtyFrame=0,this.isParent=!1,this.visible=!0,this.inputEnabled=!1,this.inputEnabledChildren=!0,this.fixBounds=!1,this.bounds=new e}isRenderable(){return this.visible&&this.willRender}setDirtyRender(t=!0){this.dirtyRender=!0;const e=this.scene;return t&&e&&(this.dirtyFrame=e.game.frame),this}setDirtyUpdate(){return this.dirtyUpdate=!0,this}getBounds(t=!1){return this.bounds}setBounds(t,e,r,s){return this.bounds.set(t,e,r,s),this}update(){}updateTransform(){return this}render(){}destroy(t){this.scene=null}}var s=0,i=1,n=2,h=3,a=4,o=5,u=6,l=7,c=8;class d extends r{constructor(t=0,e=0){super();const r=Float32Array.BYTES_PER_ELEMENT,s=new ArrayBuffer(22*r);this.transformBuffer=s,this.transformData=new Float32Array(s,0,10),this.localTransform=new Float32Array(s,10*r,6),this.worldTransform=new Float32Array(s,16*r,6),this.transformData.set([t,e,.5,.5,0,0,1,1,0,0]),this.localTransform.set([1,0,0,1,0,0]),this.worldTransform.set([1,0,0,1,0,0]),this.width=0,this.height=0,this.updateCache()}updateCache(){const t=this.localTransform,{rotation:e,skewX:r,skewY:s,scaleX:i,scaleY:n}=this;return t.set([Math.cos(e+s)*i,Math.sin(e+s)*i,-Math.sin(e-r)*n,Math.cos(e-r)*n]),this.updateTransform()}updateTransform(){this.setDirtyRender();const t=this.parent,e=this.localTransform,r=this.worldTransform;if(e[4]=this.x,e[5]=this.y,!t)return r.set(e),this;const[s,i,n,h,a,o]=e,[u,l,c,d,f,m]=t.worldTransform;return r.set([s*u+i*c,s*l+i*d,n*u+h*c,n*l+h*d,a*u+o*c+f,a*l+o*d+m]),this}setSize(t,e){return this.width=t,this.height=e,this}setOrigin(t,e=t){const r=this.transformData;return r[n]=t,r[h]=e,this}setPosition(t,e=t){const r=this.transformData;return r[s]=t,r[i]=e,this.updateTransform()}setRotation(t){const e=this.transformData;return t!==e[c]&&(e[c]=t,this.updateCache()),this}setScale(t,e=t){const r=this.transformData;return r[u]=t,r[l]=e,this.updateCache()}setSkew(t,e=t){const r=this.transformData;return r[a]=t,r[o]=e,this.updateCache()}destroy(){super.destroy(),this.localTransform=null,this.worldTransform=null,this.transformBuffer=null,this.transformData=null}set x(t){this.transformData[s]=t,this.updateTransform()}get x(){return this.transformData[s]}set y(t){this.transformData[i]=t,this.updateTransform()}get y(){return this.transformData[i]}get originX(){return this.transformData[n]}set originX(t){this.transformData[n]=t}get originY(){return this.transformData[h]}set originY(t){this.transformData[h]=t}set skewX(t){const e=this.transformData;t!==e[a]&&(e[a]=t,this.updateCache())}get skewX(){return this.transformData[a]}set skewY(t){const e=this.transformData;t!==e[o]&&(e[o]=t,this.updateCache())}get skewY(){return this.transformData[o]}set scaleX(t){const e=this.transformData;t!==e[u]&&(e[u]=t,this.updateCache())}get scaleX(){return this.transformData[u]}set scaleY(t){const e=this.transformData;t!==e[l]&&(e[l]=t,this.updateCache())}get scaleY(){return this.transformData[l]}set rotation(t){const e=this.transformData;t!==e[c]&&(e[c]=t,this.updateCache())}get rotation(){return this.transformData[c]}}class f extends d{constructor(t=0,e=0){super(t,e),this._alpha=1,this.children=[],this.isParent=!0,this.type="Container"}update(t,e){const r=this.children;for(let s=0;s<r.length;s++){let i=r[s];i&&i.willUpdate&&i.update(t,e)}}destroy(t){this.children=null,super.destroy()}get numChildren(){return this.children.length}get alpha(){return this._alpha}set alpha(t){t!==this._alpha&&(this._alpha=t,this.setDirtyRender())}}class m{constructor(t,e,r,s,i,n){this.trimmed=!1,this.texture=t,this.key=e,this.x=r,this.y=s,this.width=i,this.height=n,this.sourceSizeWidth=i,this.sourceSizeHeight=n,this.updateUVs()}setPivot(t,e){this.pivot={x:t,y:e}}setSize(t,e){this.width=t,this.height=e,this.sourceSizeWidth=t,this.sourceSizeHeight=e,this.updateUVs()}setSourceSize(t,e){this.sourceSizeWidth=t,this.sourceSizeHeight=e}setTrim(t,e,r,s,i,n){this.trimmed=!0,this.sourceSizeWidth=t,this.sourceSizeHeight=e,this.spriteSourceSizeX=r,this.spriteSourceSizeY=s,this.spriteSourceSizeWidth=i,this.spriteSourceSizeHeight=n}updateUVs(){const{x:t,y:e,width:r,height:s}=this,i=this.texture.width,n=this.texture.height;this.u0=t/i,this.v0=e/n,this.u1=(t+r)/i,this.v1=(e+s)/n}}let x;var g={get:function(){return x},set:function(t){x=t}};function T(t){const e=g.get();e.isTexture(t)&&e.deleteTexture(t)}function p(t,e,r,s=!0,i=!0){const n=g.get(),h=n.createTexture();n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,h),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t?(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),e=t.width,r=t.height):n.texImage2D(n.TEXTURE_2D,0,n.RGBA,e,r,0,n.RGBA,n.UNSIGNED_BYTE,null);const a=i?n.LINEAR:n.NEAREST;n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,a);const o=t&&function(t,e){return!(t<1||e<1)&&(0==(t&t-1)&&0==(e&e-1))}(e,r),u=o&&s?n.REPEAT:n.CLAMP_TO_EDGE;return n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,u),o&&n.generateMipmap(n.TEXTURE_2D),h}class w{constructor(t,e,r){this.key="",this.glIndex=0,this.glIndexCounter=-1,t&&(e=t.width,r=t.height),this.image=t,this.width=e,this.height=r,this.frames=new Map,this.data={},this.add("__BASE",0,0,e,r)}add(t,e,r,s,i){if(this.frames.has(t))return null;let n=new m(this,t,e,r,s,i);return this.frames.set(t,n),this.firstFrame&&"__BASE"!==this.firstFrame.key||(this.firstFrame=n),n}get(t){if(!t)return this.firstFrame;t instanceof m&&(t=t.key);let e=this.frames.get(t);return e||(console.warn("Texture.frame missing: "+t),e=this.firstFrame),e}getFrames(t){const e=[];return t.forEach(t=>{e.push(this.get(t))}),e}getFramesInRange(t,e,r,s=0,i=""){const n=[],h=e<r?1:-1;r+=h;for(let a=e;a!==r;a+=h)n.push(t+a.toString().padStart(s,"0")+i);return this.getFrames(n)}setSize(t,e){this.width=t,this.height=e,this.frames.get("__BASE").setSize(t,e)}setFilter(t){!function(t,e=!0){const r=g.get();r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t);const s=e?r.LINEAR:r.NEAREST;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,s),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,s)}(this.glTexture,t)}createGL(){this.glTexture&&T(this.glTexture),this.glTexture=p(this.image)}updateGL(){this.glTexture?function(t,e,r=!1){const s=g.get(),i=t.width,n=t.height;i>0&&n>0&&(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,e),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t))}(this.image,this.glTexture):this.glTexture=p(this.image)}destroy(){this.frames.clear(),this.image=null,this.firstFrame=null,this.data=null,T(this.glTexture),function(t){const e=g.get();e.isFramebuffer(t)&&e.deleteFramebuffer(t)}(this.glFramebuffer)}}let v;var E={get:function(){return v},set:function(t){v=t}};function y(t,...e){e.forEach(e=>{let r=e.texture.get(t);if(r===e.frame)return;e.frame=r,e.setSize(r.sourceSizeWidth,r.sourceSizeHeight),e.setBounds(e.x,e.y,e.width,e.height),r.pivot&&e.setOrigin(r.pivot.x,r.pivot.y);let s=e.vertexData;s[2]=r.u0,s[3]=r.v0,s[8]=r.u0,s[9]=r.v1,s[14]=r.u1,s[15]=r.v1,s[20]=r.u1,s[21]=r.v0,e.setDirtyRender(),e.hasTexture=!0})}var b={Container:f,GameObject:r,Sprite:class extends f{constructor(t,e,r,s){super(t,e),this.hasTexture=!1,this._tint=16777215,this._prevTextureID=-1,this.vertexData=new Float32Array(24).fill(0),this.vertexColor=new Uint32Array(4).fill(4294967295),this.vertexAlpha=new Float32Array(4).fill(1),this.vertexTint=new Uint32Array(4).fill(16777215),this.type="Sprite",this.setTexture(r,s),this.setBounds(t,e,this.width,this.height)}getBounds(t=!1){return this.dirtyRender&&this.updateVertices(),super.getBounds(t),this.bounds}setTexture(t,e){return function(t,e,...r){r.forEach(r=>{t&&(r.texture=t instanceof w?t:E.get().textures.get(t),r.texture?y(e,r):console.warn("Invalid Texture key: "+t))})}(t,e,this),this}setFrame(t){return y(t,this),this}isRenderable(){return this.visible&&this.willRender&&this.hasTexture&&this.alpha>0}updateVertices(){const t=this.vertexData;this.dirtyRender=!1;const e=this.frame,r=this.originX,s=this.originY;let i,n,h,a;const[o,u,l,c,d,f]=this.worldTransform;e.trimmed?(n=e.spriteSourceSizeX-r*e.sourceSizeWidth,i=n+e.spriteSourceSizeWidth,a=e.spriteSourceSizeY-s*e.sourceSizeHeight,h=a+e.spriteSourceSizeHeight):(n=-r*e.sourceSizeWidth,i=n+e.sourceSizeWidth,a=-s*e.sourceSizeHeight,h=a+e.sourceSizeHeight);const m=n*o+a*l+d,x=n*u+a*c+f,g=n*o+h*l+d,T=n*u+h*c+f,p=i*o+h*l+d,w=i*u+h*c+f,v=i*o+a*l+d,E=i*u+a*c+f;t[0]=m,t[1]=x,t[6]=g,t[7]=T,t[12]=p,t[13]=w,t[18]=v,t[19]=E;const y=this.bounds;y.x=Math.min(m,g,p,v),y.y=Math.min(x,T,w,E),y.right=Math.max(m,g,p,v),y.bottom=Math.max(x,T,w,E)}uploadBuffers(t,e,r,s=!0){this.dirtyRender&&this.updateVertices();const i=this.vertexData,n=this.texture.glIndex;s&&n!==this._prevTextureID&&(this._prevTextureID=n,i[4]=n,i[10]=n,i[16]=n,i[22]=n),t.set(i,r);const h=this.vertexColor;e[r+5]=h[0],e[r+11]=h[2],e[r+17]=h[3],e[r+23]=h[1]}destroy(t){super.destroy(t),this.texture=null,this.frame=null,this.hasTexture=!1,this.vertexData=null,this.vertexColor=null,this.vertexAlpha=null,this.vertexTint=null}get tint(){return this._tint}set tint(t){this._tint=t}}},S=Object.freeze({__proto__:null,default:b});const R={linear:t=>t,inQuad:t=>t*t,outQuad:t=>t*(2-t),inOutQuad:t=>t<.5?2*t*t:(4-2*t)*t-1,inCubic:t=>t*t*t,outCubic:t=>--t*t*t+1,inOutCubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,inQuart:t=>t*t*t*t,outQuart:t=>1- --t*t*t*t,inOutQuart:t=>t<.5?8*t*t*t*t:1-8*--t*t*t*t,inQuint:t=>t*t*t*t*t,outQuint:t=>1+--t*t*t*t*t,inOutQuint:t=>t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t,inSine:t=>-1*Math.cos(t/1*(.5*Math.PI))+1,outSine:t=>Math.sin(t/1*(.5*Math.PI)),inOutSine:t=>-.5*(Math.cos(Math.PI*t)-1),inExpo:t=>0==t?0:Math.pow(2,10*(t-1)),outExpo:t=>1==t?1:1-Math.pow(2,-10*t),inOutExpo:t=>0==t?0:1==t?1:(t/=.5)<1?.5*Math.pow(2,10*(t-1)):.5*(2-Math.pow(2,-10*--t)),inCirc:t=>-1*(Math.sqrt(1-t*t)-1),outCirc:t=>Math.sqrt(1-(t-=1)*t),inOutCirc:t=>(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1),inElastic:t=>{if(0==t)return 0;if(1==t)return 1;let e=1.70158,r=0;return r||(r=.3),e=r/(2*Math.PI)*Math.asin(1),-1*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)},outElastic:t=>{if(0==t)return 0;if(1==t)return 1;let e=1.70158,r=0;return r||(r=.3),e=r/(2*Math.PI)*Math.asin(1),1*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/r)+1},inOutElastic:t=>{if(0==t)return 0;if(2==(t/=.5))return 1;let e=1.70158,r=0;return r||(r=.3*1.5),e=r/(2*Math.PI)*Math.asin(1),t<1?1*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)*-.5:1*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)*.5+1},inBack:(t,e=1.70158)=>1*t*t*((e+1)*t-e),outBack:(t,e=1.70158)=>1*((t=t/1-1)*t*((e+1)*t+e)+1),inOutBack:(t,e=1.70158)=>(t/=.5)<1?t*t*((1+(e*=1.525))*t-e)*.5:.5*((t-=2)*t*((1+(e*=1.525))*t+e)+2),inBounce:t=>1-R.outBounce(1-t),outBounce:t=>(t/=1)<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,inOutBounce:t=>t<.5?.5*R.inBounce(2*t):.5*R.outBounce(2*t-1)+.5};class _{constructor(t=0,e=t){this.set(t,e)}set(t=0,e=0){return this.x=t,this.y=e,this}}function F(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}var A={AppendMatrix2d:function(t,e,r=new Float32Array(6)){const[s,i,n,h,a,o]=t,[u,l,c,d,f,m]=e;return r.set([u*s+l*n,u*i+l*h,c*s+d*n,c*i+d*h,f*s+m*n+a,f*i+m*h+o]),r},Between:function(t,e){return Math.floor(Math.random()*(e-t+1)+t)},Ease:function(t,e){if(R[e])return R[e](t)},FloatBetween:function(t,e){return Math.random()*(e-t)+t},GlobalToLocal:function(t,e,r,s=new _){const[i,n,h,a,o,u]=t,l=1/(i*a+h*-n);return s.x=a*l*e+-h*l*r+(u*h-o*a)*l,s.y=i*l*r+-n*l*e+(-u*i+o*n)*l,s},LocalToGlobal:function(t,e,r,s=new _){const[i,n,h,a,o,u]=t;return s.x=i*e+h*r+o,s.y=n*e+a*r+u,s},Matrix2dEqual:F,Vec2:_},C=Object.freeze({__proto__:null,default:A});function M(t,e){const r=document.createElement("canvas");return r.width=t,r.height=e,r.getContext("2d")}function D(t,e,r,s){const i=t.texture;i.glIndexCounter<s&&e.requestTexture(i),r.count===r.batchSize&&r.flush(),t.uploadBuffers(r.vertexViewF32,r.vertexViewU32,r.count*r.quadElementSize),r.count++}function B(t,e,r=-1,s=1){return new Float32Array([1/-t*-2,0,0,0,0,1/e*-2,0,0,0,0,1/(r-s)*2,0,-1,1,0,1])}class L{constructor(){this.textures=new Map,this.createDefaultTextures()}createDefaultTextures(){this.add("__BLANK",new w(M(32,32).canvas));const t=M(32,32);t.strokeStyle="#0f0",t.moveTo(0,0),t.lineTo(32,32),t.stroke(),t.strokeRect(.5,.5,31,31),this.add("__MISSING",new w(t.canvas))}get(t){return this.textures.has(t)?this.textures.get(t):this.textures.get("__MISSING")}has(t){return this.textures.has(t)}add(t,e){let r;return this.textures.has(t)||(r=e instanceof w?e:new w(e),r.key=t,r.glTexture||r.createGL(),this.textures.set(t,r)),r}}var U={AtlasParser:function(t,e){let r;if(Array.isArray(e.textures)?r=e.textures[0].frames:Array.isArray(e.frames)?r=e.frames:e.hasOwnProperty("frames")?r=Object.values(e.frames):console.warn("Invalid Texture Atlas JSON"),r){let e;for(let s=0;s<r.length;s++){let i=r[s];e=t.add(i.filename,i.frame.x,i.frame.y,i.frame.w,i.frame.h),i.trimmed?e.setTrim(i.sourceSize.w,i.sourceSize.h,i.spriteSourceSize.x,i.spriteSourceSize.y,i.spriteSourceSize.w,i.spriteSourceSize.h):e.setSourceSize(i.sourceSize.w,i.sourceSize.h),i.rotated,i.anchor&&e.setPivot(i.anchor.x,i.anchor.y)}}},CanvasTexture:function(t=32,e=32){const r=M(t,e);return new w(r.canvas)},CreateCanvas:M,Frame:m,GridTexture:function(t,e,r=32,s=32,i=2,n=2){const h=M(r,s),a=r/i,o=s/n;h.fillStyle=t,h.fillRect(0,0,r,s),h.fillStyle=e;for(let t=0;t<n;t++)for(let e=t%2;e<i;e+=2)h.fillRect(e*a,t*o,a,o);return new w(h.canvas)},RenderTexture:class extends w{constructor(t,e=256,r=e){super(null,e,r),this.renderer=t;const[s,i]=function(t,e){const r=g.get(),s=p(null,t,e),i=r.createFramebuffer();return r.bindFramebuffer(r.FRAMEBUFFER,i),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,s,0),r.bindFramebuffer(r.FRAMEBUFFER,null),[s,i]}(e,r);this.glTexture=s,this.glFramebuffer=i,this.projectionMatrix=B(e,r),this.cameraMatrix=new Float32Array([1,0,0,0,0,-1,0,0,0,0,1,0,0,r,0,1])}cls(){const t=this.renderer,e=t.gl;return t.reset(this.glFramebuffer,this.width,this.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),t.reset(),this}batchStart(){const t=this.renderer;return t.reset(this.glFramebuffer,this.width,this.height),t.shader.bind(this.projectionMatrix,this.cameraMatrix),this}batchDraw(...t){const e=this.renderer,r=e.shader;for(let s=0;s<t.length;s++)D(t[s],e,r,e.startActiveTexture);return this}batchEnd(){const t=this.renderer;return t.shader.flush(),t.reset(),this}draw(...t){return this.batchStart(),this.batchDraw(...t),this.batchEnd(),this}},SolidColorTexture:function(t="rgba(0,0,0,0)",e=32,r=32){const s=M(e,r);return s.fillStyle=t,s.fillRect(0,0,e,r),new w(s.canvas)},SpriteSheetParser:function(t,e,r,s,i,n){let{frameWidth:h=null,frameHeight:a=null,startFrame:o=0,endFrame:u=-1,margin:l=0,spacing:c=0}=n;if(a||(a=h),null===h)throw new Error("SpriteSheetParser: Invalid frameWidth");let d=Math.floor((s-l+c)/(h+c))*Math.floor((i-l+c)/(a+c));0===d&&console.warn("SpriteSheetParser: Frame config will result in zero frames"),(o>d||o<-d)&&(o=0),o<0&&(o=d+o),-1!==u&&(d=o+(u+1));let f=l,m=l,x=0,g=0;for(let n=0;n<d;n++){x=0,g=0;let o=f+h,u=m+a;o>s&&(x=o-s),u>i&&(g=u-i),t.add(n,e+f,r+m,h-x,a-g),f+=h+c,f+h>s&&(f=l,m+=a+c)}},Texture:w,TextureManager:L},z=Object.freeze({__proto__:null,default:U});const P=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join("\n");function I(t){let e="";for(let r=0;r<t;++r)r>0&&(e+="\nelse "),r<t-1&&(e+=`if(test == ${r}.0){}`);return e}const O={fragmentShader:"\nprecision highp float;\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vTintColor;\nuniform sampler2D uTexture[%count%];\nvoid main (void)\n{\n    vec4 color;\n    %forloop%\n    gl_FragColor = color * vec4(vTintColor.bgr * vTintColor.a, vTintColor.a);\n}",vertexShader:"\nprecision highp float;\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute float aTextureId;\nattribute vec4 aTintColor;\nuniform mat4 uProjectionMatrix;\nuniform mat4 uCameraMatrix;\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vTintColor;\nvoid main (void)\n{\n    vTextureCoord = aTextureCoord;\n    vTextureId = aTextureId;\n    vTintColor = aTintColor;\n    gl_Position = uProjectionMatrix * uCameraMatrix * vec4(aVertexPosition, 0.0, 1.0);\n}"};class k{constructor(t,e={}){this.attribs={aVertexPosition:0,aTextureCoord:0,aTextureId:0,aTintColor:0},this.uniforms={uProjectionMatrix:0,uCameraMatrix:0,uTexture:0},this.dataSize=4,this.indexSize=4,this.vertexElementSize=6,this.vertexByteSize=24,this.quadByteSize=96,this.quadElementSize=24,this.quadIndexSize=6,this.renderer=t,this.gl=t.gl;const{batchSize:r=4096,fragmentShader:s=O.fragmentShader,vertexShader:i=O.vertexShader}=e;this.batchSize=r,this.bufferByteSize=r*this.quadByteSize,this.createBuffers(),this.createShaders(s,i),this.count=0}createBuffers(){let t=[];for(let e=0;e<this.batchSize*this.indexSize;e+=this.indexSize)t.push(e+0,e+1,e+2,e+2,e+3,e+0);this.data=new ArrayBuffer(this.bufferByteSize),this.index=new Uint16Array(t),this.vertexViewF32=new Float32Array(this.data),this.vertexViewU32=new Uint32Array(this.data);const e=this.gl;this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.data,e.DYNAMIC_DRAW),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.index,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),t=[]}createShaders(t,e){const r=this.gl,s=this.renderer.maxTextures;let i="";if(s>1){for(let t=0;t<s;t++)t>0&&(i+="\nelse "),t<s-1&&(i+=`if (vTextureId < ${t}.5)`),i+="\n{",i+=`\n  color = texture2D(uTexture[${t}], vTextureCoord);`,i+="\n}";t=(t=t.replace(/%count%/gi,""+s)).replace(/%forloop%/gi,i)}else i="color = texture2D(uTexture[0], vTextureCoord);";const n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(n,t),r.compileShader(n);const h=r.createShader(r.VERTEX_SHADER);r.shaderSource(h,e),r.compileShader(h);const a=r.createProgram();r.attachShader(a,h),r.attachShader(a,n),r.linkProgram(a),r.useProgram(a),this.program=a;for(let t of Object.keys(this.attribs)){let e=r.getAttribLocation(a,t);r.enableVertexAttribArray(e),this.attribs[t]=e}for(let t of Object.keys(this.uniforms))this.uniforms[t]=r.getUniformLocation(a,t)}bind(t,e){const r=this.gl,s=this.renderer,i=this.uniforms;r.useProgram(this.program),r.uniformMatrix4fv(i.uProjectionMatrix,!1,t),r.uniformMatrix4fv(i.uCameraMatrix,!1,e),r.uniform1iv(i.uTexture,s.textureIndex),this.bindBuffers(this.indexBuffer,this.vertexBuffer)}bindBuffers(t,e){const r=this.gl,s=this.vertexByteSize,i=this.attribs;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),r.bindBuffer(r.ARRAY_BUFFER,e),r.vertexAttribPointer(i.aVertexPosition,2,r.FLOAT,!1,s,0),r.vertexAttribPointer(i.aTextureCoord,2,r.FLOAT,!1,s,8),r.vertexAttribPointer(i.aTextureId,1,r.FLOAT,!1,s,16),r.vertexAttribPointer(i.aTintColor,4,r.UNSIGNED_BYTE,!0,s,20),this.count=0}draw(t){const e=this.gl,r=t*this.quadByteSize;if(r===this.bufferByteSize)e.bufferData(e.ARRAY_BUFFER,this.data,e.DYNAMIC_DRAW);else{let t=this.vertexViewF32.subarray(0,r);e.bufferSubData(e.ARRAY_BUFFER,0,t)}e.drawElements(e.TRIANGLES,t*this.quadIndexSize,e.UNSIGNED_SHORT,0)}flush(){const t=this.count;return 0!==t&&(this.draw(t),this.prevCount=t,this.count=0,this.renderer.flushTotal++,!0)}}class X{constructor(t,e,r){this.contextOptions={alpha:!1,antialias:!1,premultipliedAlpha:!1,stencil:!1,preserveDrawingBuffer:!1,desynchronized:!1},this.clearColor=[0,0,0,1],this.flushTotal=0,this.maxTextures=0,this.currentActiveTexture=0,this.startActiveTexture=0,this.tempTextures=[],this.clearBeforeRender=!0,this.optimizeRedraw=!0,this.autoResize=!0,this.contextLost=!1,this.width=t,this.height=e,this.resolution=r;const s=document.createElement("canvas");s.addEventListener("webglcontextlost",t=>this.onContextLost(t),!1),s.addEventListener("webglcontextrestored",()=>this.onContextRestored(),!1),this.canvas=s,this.initContext(),this.shader=new k(this)}initContext(){const t=this.canvas.getContext("webgl",this.contextOptions);g.set(t),this.gl=t,this.elementIndexExtension=t.getExtension("OES_element_index_uint"),this.getMaxTextures(),this.shader&&(this.shader.gl=t),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),this.resize(this.width,this.height,this.resolution)}resize(t,e,r=1){this.width=t*r,this.height=e*r,this.resolution=r;const s=this.canvas;s.width=this.width,s.height=this.height,this.autoResize&&(s.style.width=this.width/r+"px",s.style.height=this.height/r+"px"),this.gl.viewport(0,0,this.width,this.height),this.projectionMatrix=B(t,e)}onContextLost(t){t.preventDefault(),this.contextLost=!0}onContextRestored(){this.contextLost=!1,this.initContext()}setBackgroundColor(t){const e=this.clearColor,r=t>>16&255,s=t>>8&255,i=255&t,n=t>16777215?t>>>24:255;return e[0]=r/255,e[1]=s/255,e[2]=i/255,e[3]=n/255,this}getMaxTextures(){const t=this.gl;let e=function(t,e){const r=e.createShader(e.FRAGMENT_SHADER);for(;;){const s=P.replace(/%forloop%/gi,I(t));if(e.shaderSource(r,s),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))break;t=t/2|0}return t}(t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t);const r=this.tempTextures;r.length&&r.forEach(e=>{t.deleteTexture(e)});for(let s=0;s<e;s++){let e=t.createTexture();t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),r[s]=e}this.maxTextures=e,this.textureIndex=Array.from(Array(e).keys()),this.activeTextures=Array(e),this.currentActiveTexture=0}reset(t=null,e=this.width,r=this.height){const s=this.gl;s.bindFramebuffer(s.FRAMEBUFFER,t),s.viewport(0,0,e,r),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),this.currentActiveTexture=0,this.startActiveTexture++,this.flushTotal=0}render(t,e,r){if(this.contextLost)return;const s=this.gl;this.flushTotal;if(this.reset(),this.optimizeRedraw&&0===e&&0===r)return;const i=this.shader,n=this.clearColor;this.clearBeforeRender&&(s.clearColor(n[0],n[1],n[2],n[3]),s.clear(s.COLOR_BUFFER_BIT));const h=this.projectionMatrix;let a;for(let e=0;e<t.length;e+=2){let r=t[e],s=t[e+1];a&&F(r.worldTransform,a.worldTransform)||(i.flush(),i.bind(h,r.matrix),a=r);for(let t=0;t<s.length;t++)D(s[t],this,i,this.startActiveTexture)}i.flush()}resetTextures(t){const e=this.gl,r=this.activeTextures;r.fill(null),this.currentActiveTexture=0,this.startActiveTexture++,t&&(r[0]=t,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t.glTexture),this.currentActiveTexture=1)}requestTexture(t){const e=this.gl;t.glIndexCounter=this.startActiveTexture,this.currentActiveTexture<this.maxTextures?(this.activeTextures[this.currentActiveTexture]=t,t.glIndex=this.currentActiveTexture,e.activeTexture(e.TEXTURE0+this.currentActiveTexture),e.bindTexture(e.TEXTURE_2D,t.glTexture),this.currentActiveTexture++):(this.shader.flush(),this.resetTextures(t))}}function N(t,e,r){return t.hasOwnProperty(e)?t[e]:r}class G{constructor(t){this.sceneIndex=0,this.flush=!1,this.dirtyCameras=0,this.dirtyFrame=0,this.totalFrame=0,this.game=t,this.scenes=new Map,this.renderList=[]}boot(t){t.forEach(t=>{this.add(t)})}add(t){const e=new t;e.willUpdate&&e.boot.call(e)}init(t,e={}){const r=this.scenes.size,s=this.sceneIndex,i=0===r;"string"==typeof e?t.key=e:(e||!e&&i)&&(t.key=N(e,"key","scene"+s),t.willUpdate=N(e,"willUpdate",i),t.willRender=N(e,"willRender",i)),this.scenes.has(t.key)?console.warn("Scene key already in use: "+t.key):(this.scenes.set(t.key,t),this.flush=!0,this.sceneIndex++)}update(t,e){for(const r of this.scenes.values())r.willUpdate&&(r.update.call(r,t,e),r.world.update(t,e))}render(t){const e=this.renderList;e.length=0,this.dirtyCameras=0,this.dirtyFrame=0,this.totalFrame=0;for(let r of this.scenes.values())if(r.willRender){let s=r.world;if(this.dirtyFrame+=s.render(t),this.totalFrame+=s.totalFrame,0===s.renderList.length)continue;s.camera.dirtyRender&&(this.dirtyCameras++,s.camera.dirtyRender=!1),e.push(s.camera),e.push(s.renderList)}return this.flush&&(this.dirtyFrame++,this.flush=!1),[e,this.dirtyFrame,this.dirtyCameras]}}class Y{constructor(t,e,r=!1){this.callback=t,this.context=e,this.once=r}}class q{constructor(){this._events=new Map}on(t,e,r=this,s=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const i=new Y(e,r,s),n=this._events.get(t);return n?n.add(i):this._events.set(t,new Set([i])),this}once(t,e,r=this){return this.on(t,e,r,!0)}clearEvent(t){return this._events.delete(t),this}eventNames(){return[...this._events.keys()]}listeners(t){const e=[];return this._events.get(t).forEach(t=>{e.push(t.callback)}),e}listenerCount(t){const e=this._events.get(t);return e?e.size:0}emit(t,...e){if(!this._events.has(t))return!1;const r=this._events.get(t);for(const t of r)t.callback.apply(t.context,e),t.once&&r.delete(t);return 0===r.size&&this._events.delete(t),!0}off(t,e,r,s){if(e){const i=this._events.get(t),n=!r,h=void 0!==s;for(const t of i)t.callback===e&&n&&t.context===console&&h&&t.once===s&&i.delete(t);0===i.size&&this._events.delete(t)}else this._events.delete(t);return this}removeAllListeners(t){t?this._events.delete(t):this._events.clear()}}class j extends d{constructor(t=0,e=0){super(t,e),this.type="Camera";const r=E.get();this.renderer=r.renderer,this.reset()}updateTransform(){if(!this.renderer)return this;this.dirtyRender=!0;const t=this.localTransform,e=this.worldTransform;t[4]=0-this.x,t[5]=0-this.y;const r=this.matrix,[s,i,n,h,a,o]=t,u=this.renderer.width*this.originX,l=this.renderer.height*this.originY;r[0]=s,r[1]=i,r[4]=n,r[5]=h;const c=s*-u+n*-l+(u+a),d=i*-u+h*-l+(l+o);return r[12]=c,r[13]=d,e.set([s,i,n,h,c,d]),this.bounds.x=-1*c,this.bounds.y=-1*d,this}reset(){this.matrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);const t=this.renderer.width,e=this.renderer.height;this.setSize(t,e),this.setBounds(0,0,t,e)}destroy(){super.destroy(),this.renderer=null,this.matrix=null}}class V{constructor(t){this.dirtyFrame=0,this.totalFrame=0,this.visibleFrame=0,this.boundsFrame=0,this.forceRefresh=!1,this.enableCameraCull=!0,this.scene=t,this.children=[],this.renderList=[],this.worldTransform=new Float32Array([1,0,0,1,0,0]),this.camera=new j}scanChildren(t,e){const r=t.children;for(let t=0;t<r.length;t++)this.buildRenderList(r[t],e)}buildRenderList(t,e){if(t.isRenderable()){const i=this.enableCameraCull;i&&(!i||(r=t.getBounds(),s=this.camera.bounds,r.width<=0||r.height<=0||s.width<=0||s.height<=0||r.right<s.x||r.bottom<s.y||r.x>s.right||r.y>s.bottom))||(this.renderList.push(t),t.dirtyFrame>=e&&this.dirtyFrame++),this.visibleFrame++}var r,s;t.isParent&&t.visible&&this.scanChildren(t,e)}update(t,e){const r=this.children;for(let s=0;s<r.length;s++){let i=r[s];i&&i.willUpdate&&i.update(t,e)}}render(t){return this.dirtyFrame=0,this.boundsFrame=0,this.visibleFrame=0,this.renderList.length=0,this.scanChildren(this,t),this.totalFrame=this.renderList.length,this.forceRefresh&&(this.dirtyFrame++,this.forceRefresh=!1),this.dirtyFrame}shutdown(){this.renderList=[],this.camera.reset()}destroy(){this.camera.destroy(),this.camera=null,this.renderList=null}get numChildren(){return this.children.length}}class W{constructor(t){this.scene=t,this.renderer=t.game.renderer,this.matrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.bounds=new e,this.reset()}reset(){const t=this.renderer.width,e=this.renderer.height;this.width=t,this.height=e,this.bounds.set(0,0,t,e)}destroy(){this.scene=null,this.renderer=null,this.matrix=null,this.bounds=null}}class H{constructor(t){this.dirtyFrame=0,this.totalFrame=0,this.visibleFrame=0,this.forceRefresh=!1,this.scene=t,this.children=[],this.renderList=[],this.worldTransform=new Float32Array([1,0,0,1,0,0]),this.camera=new W(t)}scanChildren(t,e){const r=t.children;for(let t=0;t<r.length;t++)this.buildRenderList(r[t],e)}buildRenderList(t,e){t.isRenderable()&&(this.renderList.push(t),t.dirtyFrame>=e&&this.dirtyFrame++,this.visibleFrame++),t.isParent&&t.visible&&this.scanChildren(t,e)}update(t,e){const r=this.children;for(let s=0;s<r.length;s++){let i=r[s];i&&i.willUpdate&&i.update(t,e)}}render(t){return this.dirtyFrame=0,this.visibleFrame=0,this.renderList.length=0,this.scanChildren(this,t),this.totalFrame=this.renderList.length,this.forceRefresh&&(this.dirtyFrame++,this.forceRefresh=!1),this.dirtyFrame}shutdown(){this.renderList=[],this.camera.reset()}destroy(){this.camera.destroy(),this.camera=null,this.renderList=null}get numChildren(){return this.children.length}}t.EventEmitter=q,t.Game=class extends q{constructor(t){super(),this.VERSION="4.0.0-beta1",this.isPaused=!1,this.isBooted=!1,this.lifetime=0,this.elapsed=0,this.frame=0;const{width:e=800,height:r=600,resolution:s=1,backgroundColor:i=0,parent:n=document.body,scene:h=null}=t;this.config={width:e,height:r,resolution:s,backgroundColor:i,parent:n,scene:h},this.cache={json:new Map,csv:new Map,xml:new Map},E.set(this),function(t){const e=document.readyState;if("complete"===e||"interactive"===e)return void t();const r=()=>{document.removeEventListener("deviceready",r,!0),document.removeEventListener("DOMContentLoaded",r,!0),window.removeEventListener("load",r,!0),t()};document.body?window.hasOwnProperty("cordova")?document.addEventListener("deviceready",r,!0):(document.addEventListener("DOMContentLoaded",r,!0),window.addEventListener("load",r,!0)):window.setTimeout(r,20)}(()=>this.boot())}pause(){this.isPaused=!0,this.emit("pause")}resume(){this.isPaused=!1,this.lastTick=Date.now(),this.emit("resume")}boot(){const t=this.config;this.isBooted=!0,this.lastTick=Date.now();const e=new X(t.width,t.height,t.resolution);e.setBackgroundColor(t.backgroundColor),function(t,e){let r;if(e)"string"==typeof e?r=document.getElementById(e):"object"==typeof e&&1===e.nodeType&&(r=e);else if(t.parentElement)return t;r||(r=document.body),r.appendChild(t)}(e.canvas,t.parent),this.renderer=e,this.textures=new L,this.scenes=new G(this),this.banner(this.VERSION),this.scenes.boot([].concat(t.scene)),document.addEventListener("visibilitychange",()=>{this.emit("visibilitychange",document.hidden),document.hidden?this.pause():this.resume()}),this.emit("boot"),requestAnimationFrame(()=>this.step())}banner(t){console.log("%cPhaser v"+t+"%c https://phaser4.io","padding: 4px 16px; color: #fff; background: linear-gradient(#3e0081 40%, #00bcc3)","")}step(){const t=Date.now(),e=(t-this.lastTick)/1e3;this.lifetime+=e,this.elapsed=e,this.lastTick=t,this.emit("step",e,t);const r=this.scenes;this.isPaused||r.update(e,t),this.emit("update",e,t);const[s,i,n]=r.render(this.frame);this.renderer.render(s,i,n),this.emit("render",e,t),this.frame++,requestAnimationFrame(()=>this.step())}destroy(){}},t.GameObjects=S,t.Loader=class extends q{constructor(){super(),this.baseURL="",this.path="",this.crossOrigin="anonymous",this.maxParallelDownloads=-1,this.isLoading=!1,this.reset()}reset(){this.isLoading=!1,this.queue=new Set,this.inflight=new Set,this.completed=new Set,this.progress=0}add(...t){return t.forEach(t=>{t.loader=this,this.queue.add(t)}),this}start(t){if(!this.isLoading)return this.completed.clear(),this.progress=0,this.queue.size>0?(this.isLoading=!0,this.onComplete=t,this.emit("start"),this.nextFile()):(this.progress=1,this.emit("complete"),t()),this}nextFile(){let t=this.queue.size;if(-1!==this.maxParallelDownloads&&(t=Math.min(t,this.maxParallelDownloads)-this.inflight.size),t){const e=this.queue.values();for(;t>0;){const r=e.next().value;this.inflight.add(r),this.queue.delete(r),r.load().then(t=>this.fileComplete(t)).catch(t=>this.fileError(t)),t--}}else 0===this.inflight.size&&this.stop()}stop(){this.isLoading=!1,this.emit("complete",this.completed),this.onComplete(),this.completed.clear()}updateProgress(t){this.inflight.delete(t),this.completed.add(t);const e=this.completed.size,r=this.queue.size+this.inflight.size;e>0&&(this.progress=e/(e+r)),this.emit("progress",this.progress,e,r),this.nextFile()}fileComplete(t){this.emit("filecomplete",t),this.updateProgress(t)}fileError(t){this.emit("fileerror",t),this.updateProgress(t)}totalFilesToLoad(){return this.queue.size+this.inflight.size}setBaseURL(t=""){return""!==t&&"/"!==t.substr(-1)&&(t=t.concat("/")),this.baseURL=t,this}setPath(t=""){return""!==t&&"/"!==t.substr(-1)&&(t=t.concat("/")),this.path=t,this}setCORS(t){return this.crossOrigin=t,this}setMaxParallelDownloads(t){return this.maxParallelDownloads=t,this}},t.Math=C,t.Scene=class{constructor(t){this.willUpdate=!1,this.willRender=!1,this.game=E.get(),this.world=new V(this),this.game.scenes.init(this,t)}boot(){}update(){}render(){}shutdown(){}destroy(){this.world.destroy(),this.world=null,this.game=null}},t.StaticScene=class{constructor(t){this.willUpdate=!1,this.willRender=!1,this.game=E.get(),this.world=new H(this),this.game.scenes.init(this,t)}boot(){}update(){}render(){}shutdown(){}destroy(){this.world.destroy(),this.world=null,this.game=null}},t.Textures=z,t.WebGLRenderer=X,Object.defineProperty(t,"__esModule",{value:!0})}));
